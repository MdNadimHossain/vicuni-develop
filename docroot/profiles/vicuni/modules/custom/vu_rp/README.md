# VU Researcher Profiles

## Code organisation.
1. Module, info and install files are in the root.
2. Feature-related files are in the root.
3. Functionality includes are in `includes` directory.
4. Contrib modules hook implementations are in `includes/modules` directory.
3. Sub-modules as in the `modules` directory.
4. Blocks, layouts, theme - in own directories inside `includes`.
5. CSS and JS - in own directories.
 
## Modules
`vu_rp` - Researcher Profile content type and fields.
`vu_rp_api` - API integration with VU systems. 
`vu_rp_log` - Logging for API integration with VU systems.
`vu_rp_list` - List of researchers.
`vu_rp_test` - Testing for API and a profile.
`vu_rp_demo` - Researcher profile demo content.

### Rules for code organisation.
1. If it is a hook implementation of core module - place it into `.module` file.
2. If it is a hook implementation of the contrib module - place it into a separate `include/module/{module_name}.inc` file. Place all related functions in this file as well.
3. If it is a logic related to node data retrieval - place it into a separate file `include/node.inc` file. Place all related private functions in this file as well.
4. If it is a context-independent logic (like formatting a date) - place it into `include/helpers.inc`.
5. If it is an config UI - place it into `include/admin.inc`.
6. If it is related to particular form - place it into `include/forms/{form_id}.inc`.
7. If it is an alteration of a part of the form - place it into `include/forms/common.inc`.

## API data pipeline

### Storing received data
1. Data retrieved from API as JSON using queues (see comment in the `vu_rp_api.module`).
2. Data converted to PHP object. 
3. Data converted into internal Drupal storage using one of the field Processors.
4. Data is recorded into log (if module is enabled).

### Rendering data in front-end
1. Research Profile page has layout in `includes/layouts/vu_rp/vu-rp.tpl.php`.
2. Layout has layout regions defined.
3. Display Suite is used to create block fields and reference blocks.
4. Each block is located in `includes/blocks` directory.
5. Within a block, a centralised Getter is called for the field. This getter converts data stored in Drupal fields into data structure suitable for theme output. It also contains all required business logic.
6. Blocks use the data received from Getter and add visual logic (no content messages etc.) and call per block themes implemented as templates located in `includes/templates`. Blocks works as theme pre-processors in this case (there is no reason to create another layer to pre-process data between blocks and templates).
7. Templates render data passed from blocks.  
 
### Rendering data in the admin UI
1. Research Profile form has a template file `includes/templates/researcher-profile-node-form.tpl.php`.
2. This file has all fields printed in code. Important: we are still using form layout and groups to structure fields. We then output these fields using the structure generated by form layout.
3. We use form alter in `includes/forms/researcher_profile_node_form.inc` to alter Researcher Profile node form. We then inject fields with render callbacks stored in the same file.
4. To simplify code management, render callbacks are simple functions using data from Getters (which guarantees that it is the same data as for FE) + standard Drupal theming (like for `theme_table` and `theme_list`).
5. Form is then styled using SCSS `css/vu_rp.form.scss` converted to CSS.

### Fields
Fields are split into 3 types:
- Fields with `_rp_` suffix are manually entered fields.
- Fields with `_rpa_` suffix are fields coming from API.
- Fields with `_rpc_` suffix are fields calculated from API values. 
  Used to avoid saving all API data in Drupal. 

The fields of different types never get updated by a value of a different type (except when testing form - see below).

## Testing Drupal forms.
`vu_rp_test` module provides a special role `Research Profile Tester` and test users for this role.
It is used for entering values into a form directly and checking how they coming through to front-end.
Generally, this should only be used for development and debugging.
